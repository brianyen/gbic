<html>
<body>
<div id="title">
    <h1><a id="titlelink" href="/">tubeslides</a></h1>
</div>

<div style="display: flex">
	<div id="metadata">
		<div id="m-url"></div>
        <div id="m-title"></div>
		<div id="m-creator"></div>
		<div id="m-length"></div>
		<div id="description"></div>	
	</div>
	<div id="search">
		<form id="form" action="/convert_url">
			<input id="input" name="url"></input>
			<input type="submit" value="Go">
		</form>
	</div>
</div>

<div class="bar" style="margin-top: 0px"></div>

<div id="error"></div>

<div id="output"></div> 

<div id="loader"></div>

</body>
<script>
const urlParams = new URLSearchParams(window.location.search);
const id = urlParams.get('out_dir');
var urlFull
var keepTrying = true
var loaderEl = document.getElementById("loader")
var n = 0
var errorEl = document.getElementById("error")

var fetchUrl = "http://localhost:81/static"
outputEl = document.getElementById("output")


function processError(callback) {
	fetch(fetchUrl + "/errors.txt")
	.then(function(response) {
		if (response.ok == true) {
			loaderEl.style.display = "none";
			return response.json()
		} else {
			fetch(fetchUrl + "/done.txt")
			.then(function(response) {
				if (response.ok == true) {
					errorsEl.innerHTML = ""
					loaderEl.style.display = "none";
					var finishEl = document.createElement("div")
					finishEl.id = "finish"
					finishEl.innerHTML = "<h1>Fin.</h1>"
					outputEl.appendChild(finishEl)
					console.log("finished")
					return
				} else {
					errorEl.innerHTML = "We are working on converting your video right now. Please hold on!"
					setTimeout(function() {console.log("aaaaaaaaaaaaaaa"); callback(n)}, 10000);
				}
			})
		}
	})
	.then(function(errors) {
		if (errors != undefined) { 
			console.log(errors)
		}
	})

}
function processVidInfo() {
	fetch(fetchUrl + "/vid.info.json")
	.then(function(response) {
		console.log(response);
		if (response.ok != true) {
			processError(processVidInfo)
		}
		return response.json()
	})
	.then(function(data) {
		console.log(data)
		var url = document.getElementById("m-url")
		var title = document.getElementById("m-title")
		var creator = document.getElementById("m-creator")
		var length = document.getElementById("m-length")
		var description = document.getElementById("description")
		
		urlFull = data.webpage_url
		
		var date = new Date(0);
		date.setSeconds(data.duration);
		var timeString = date.toISOString().substr(11, 8);

		url.innerHTML = '<b>Video URL: </b> <a href="' + data.webpage_url + '">' + data.webpage_url + '</a>'
		title.innerHTML = '<b>Title: </b>' + data.fulltitle
		creator.innerHTML = '<b>Creator: </b>' + data.uploader
		length.innerHTML = '<b>Video Length: </b>' + timeString
		description.innerHTML = "<b>Description</b>: " + data.description
		
	})
	.catch((error) => {
			console.log("we got an error:" + error)
	})
}
processVidInfo()

function processClip(i) {
	var clip = ('0000'+i).slice(-3);
	console.log("processClip", clip );
    fetch(fetchUrl + "/clip-" + clip + "/slides.json")
	.then(function(response) {
		if (response.ok != true) {
			processError(processClip)
		}
		return response.json()
	})
	.then(function(data) {
		console.log(data)
		console.log(data.length + " length of data")
        for (let slide of data) {
            var el = document.createElement("div")
			el.className = "group"

			var time01 = slide.ts.split('-');
			var imgSecs = (+time01[0]) * 60 * 60 + (+time01[1]) * 60 + (+time01[2]); 

            var s = '<a href="' + urlFull + '&t=' + imgSecs + '"><img class="slide" src="/' + "static" + '/' + slide.png + '"></a>'
			s = s + '<div class="column">'

            for (let x of slide.text) {
				var time1 = x.ts.split('-');
				var secs = (+time1[0]) * 60 * 60 + (+time1[1]) * 60 + (+time1[2]); 
                s = s + '<a class="paragraph" href="' + urlFull + '&t=' + secs + '"> <span class="timestamp">' + x.ts + ':</span> ' + x.text + '</a>'
            }
            s = s + "</div>"
            el.innerHTML = s

            var bar = document.createElement("div")
            bar.className = "bar"

            outputEl.appendChild(el)
			outputEl.appendChild(bar)
		}
		n++;
        processClip(n)
	})
	.catch((error) => {
		console.log("we got an error:" + error)
	})
}
processClip(n);

</script>
<style>
#titlelink {
	text-decoration: none;
	color: black;
}
#body {
	margin: 0px;
}
#title, #finish {
	text-align: center;
	font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif;
	padding: 1px;
	font-size: 25px;
}
#search {
	text-align: right;
	margin: 20px;
	width: 25%;
}
#input {
	width: 80%;
}
#metadata, #error {
	padding: 0.5%;
	margin-left: 5%;
	font-size: 150%;
	font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif;
	color: rgb(30, 25, 90);
	width: 75%;
	word-wrap: break-word;
	overflow-x: hidden;
}
#description {
	font-size: 75%;
}
#form {
	display: flex;
}
.bar {
	border-top: 3px solid rgb(200, 200, 200);
	padding: 0px;
	margin: 50px;
	height: 0px;
}
.group {
	padding-bottom: 10px;
}
.slide {
	width: 100%;
	position: sticky;
	top: 0px;
	border-bottom: 3px solid rgb(200, 200, 200);
	background-color: white;
}
.paragraph {
	margin: 5%;
	font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif;
	width: 90%;
	word-wrap: break-word;
	overflow-x: hidden;
	font-size: 125%;
	margin-bottom: 0px;
	margin-top: 1%;
	display: block;
}
.paragraph:hover {
	background-color: #CCCCCC;
}
.column a {
  color: black;
  text-decoration: none;
}
.timestamp {
	font-size: 75%;
}
.error {
	font-size: 150%;
	margin-left: 5%;
	font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif;
	color: rgb(225, 40, 40);
}
#loader {
  border: 16px solid #e0d9d9; 
  border-top: 16px solid #434647;
  border-radius: 50%;
  width: 120px;
  height: 120px;
  animation: spin 2s linear infinite;
  margin: auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@media only screen and (min-width: 768px) {
	.group {
		display: flex;
	}
	div.column {
		width: 50%;
	}
	.slide {
		width: 80%;
		top: 20px;
		margin: 5%;
		margin-top: 0px;
		border: 3px solid rgb(200, 200, 200);
	}
}
</style>
</html>